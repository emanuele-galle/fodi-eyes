# GitHub Actions Deploy Workflow
# Monorepo Docker: shell + italia + mondo + osint
#
# Secrets:
# - VPS_HOST: 72.61.184.133
# - VPS_USER: sviluppatore
# - SSH_PRIVATE_KEY: contenuto ~/.ssh/github_deploy

name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_SLUG: fodi-eyes
  PROJECT_PATH: /var/www/projects/fodi-eyes

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PROJECT_PATH
          command_timeout: 12m
          script: |
            set -e
            cd $PROJECT_PATH

            echo "=== Pulling latest changes ==="
            git pull origin main

            echo "=== Building and restarting containers ==="
            docker compose build --no-cache
            docker compose up -d

            echo "=== Waiting for containers to be ready ==="
            sleep 20

            echo "=== Health checks ==="
            # Check all containers are running
            RUNNING=$(docker compose ps --status running --format json | wc -l)
            EXPECTED=4
            if [ "$RUNNING" -lt "$EXPECTED" ]; then
              echo "ERROR: Only $RUNNING/$EXPECTED containers running"
              docker compose ps
              docker compose logs --tail=30
              exit 1
            fi

            # Check italia health endpoint
            ITALIA_HEALTH=$(docker compose exec -T italia wget -qO- http://localhost:3000/api/health 2>/dev/null || echo "FAIL")
            echo "Italia health: $ITALIA_HEALTH"

            # Check osint health endpoint
            OSINT_HEALTH=$(docker compose exec -T osint wget -qO- http://localhost:3003/api/osint/health 2>/dev/null || echo "FAIL")
            echo "OSINT health: $OSINT_HEALTH"

            # External check via Traefik
            EXTERNAL_CHECK=$(curl -sf --max-time 10 "https://fodi-eyes.fodivps2.cloud/" -o /dev/null && echo "OK" || echo "FAIL")
            echo "External check: $EXTERNAL_CHECK"

            # Docker cleanup - remove old images and build cache
            echo "=== Cleaning up old Docker resources ==="
            docker image prune -f 2>/dev/null || true
            docker builder prune -f --filter "until=24h" 2>/dev/null || true

            echo "=== Deploy complete ==="
            docker compose ps

      - name: Notify deployment
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PROJECT_SLUG
          script: |
            curl -s -X POST "https://n8n.fodivps2.cloud/webhook/deploy-notify" \
              -H "Content-Type: application/json" \
              -d "{\"project\": \"$PROJECT_SLUG\", \"status\": \"${{ job.status }}\", \"commit\": \"${{ github.sha }}\", \"actor\": \"${{ github.actor }}\"}" \
              || echo "Notification webhook failed (non-critical)"
